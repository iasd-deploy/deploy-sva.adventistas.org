on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest
    environment: master
    steps:
    - name: ðŸšš Get latest code
      uses: actions/checkout@v4

    - name: Transform wp-config.php
      run: |
        echo "Init transform: wp-config.php"

        # FunÃ§Ã£o para escapar caracteres especiais em Bash
        escape_sed() {
          echo "$1" | sed -e 's/[\/&]/\\&/g'
        }

        sed -i "s/WP_DB_NAME/$(escape_sed '${{ secrets.WP_DB_NAME }}')/g" ./app/wp-config.php
        sed -i "s/WP_DB_USER/$(escape_sed '${{ secrets.WP_DB_USER }}')/g" ./app/wp-config.php
        sed -i "s/WP_DB_PASSWORD/$(escape_sed '${{ secrets.WP_DB_PASSWORD }}')/g" ./app/wp-config.php
        sed -i "s/WP_DB_HOST/$(escape_sed '${{ secrets.WP_DB_HOST }}')/g" ./app/wp-config.php
        sed -i "s/WP_S3_ACCESS_KEY/$(escape_sed '${{ secrets.WP_S3_ACCESS_KEY }}')/g" ./app/wp-config.php
        sed -i "s/WP_S3_SECRET_KEY/$(escape_sed '${{ secrets.WP_S3_SECRET_KEY }}')/g" ./app/wp-config.php
        sed -i "s/WP_S3_BUCKET/$(escape_sed '${{ secrets.WP_S3_BUCKET }}')/g" ./app/wp-config.php

        echo "End transform: wp-config.php"

    - name: ðŸ§¹ Clean Server Directory
      uses: easingthemes/ssh-deploy@main
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SOURCE: "./"
        REMOTE_HOST: ${{ secrets.FTP_HOST }}
        REMOTE_PORT: 65002
        REMOTE_USER: ${{ secrets.FTP_USER }}
        TARGET: "/home/${{ secrets.FTP_USER }}/domains/sva.adventistas.org/public_html1"
        EXCLUDE: "/dist/, /node_modules/, /app/"
        SCRIPT_AFTER: |
          cd /home/${{ secrets.FTP_USER }}/domains/sva.adventistas.org/public_html1
          echo "ðŸ§¹ Cleaning directory before deploy..."
          find . -mindepth 1 -maxdepth 1 ! -name 'wp-content' -exec rm -rf {} +
          echo "âœ… Directory cleaned successfully - only wp-content preserved"

    - name: Deploy to Server - SSH
      uses: easingthemes/ssh-deploy@main
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SOURCE: "./app/"
        REMOTE_HOST: ${{ secrets.FTP_HOST }}
        REMOTE_PORT: 65002
        REMOTE_USER: ${{ secrets.FTP_USER }}
        TARGET: "/home/${{ secrets.FTP_USER }}/domains/sva.adventistas.org/public_html1"
        EXCLUDE: "/dist/, /node_modules/"