on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  web-deploy:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest
    environment: master
    steps:
    - name: ğŸšš Get latest code
      uses: actions/checkout@v4

    - name: Transform wp-config.php
      run: |
        echo "Init transform: wp-config.php"

        # FunÃ§Ã£o para escapar caracteres especiais em Bash
        escape_sed() {
          echo "$1" | sed -e 's/[\/&]/\\&/g'
        }

        sed -i "s/WP_DB_NAME/$(escape_sed '${{ secrets.WP_DB_NAME }}')/g" ./app/wp-config.php
        sed -i "s/WP_DB_USER/$(escape_sed '${{ secrets.WP_DB_USER }}')/g" ./app/wp-config.php
        sed -i "s/WP_DB_PASSWORD/$(escape_sed '${{ secrets.WP_DB_PASSWORD }}')/g" ./app/wp-config.php
        sed -i "s/WP_DB_HOST/$(escape_sed '${{ secrets.WP_DB_HOST }}')/g" ./app/wp-config.php
        sed -i "s/WP_S3_ACCESS_KEY/$(escape_sed '${{ secrets.WP_S3_ACCESS_KEY }}')/g" ./app/wp-config.php
        sed -i "s/WP_S3_SECRET_KEY/$(escape_sed '${{ secrets.WP_S3_SECRET_KEY }}')/g" ./app/wp-config.php
        sed -i "s/WP_S3_BUCKET/$(escape_sed '${{ secrets.WP_S3_BUCKET }}')/g" ./app/wp-config.php

        echo "End transform: wp-config.php"

    - name: ğŸ“¤ Upload Files to Server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.FTP_HOST }}
        port: 65002
        username: ${{ secrets.FTP_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "./app/*"
        target: "/tmp/wordpress-deploy/"
        strip_components: 0

    - name: ğŸš€ Smart Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.FTP_HOST }}
        port: 65002
        username: ${{ secrets.FTP_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /home/${{ secrets.FTP_USER }}/domains/sva.adventistas.org/public_html1
          echo "ğŸ§¹ Limpando TUDO do diretÃ³rio html..."
          
          # Preservar APENAS os uploads (arquivos de mÃ­dia dos usuÃ¡rios)
          if [ -d "wp-content/uploads" ]; then
            echo "ğŸ“ Preservando wp-content/uploads (arquivos de mÃ­dia)"
            mkdir -p /tmp/uploads-backup
            cp -r wp-content/uploads/* /tmp/uploads-backup/
            echo "âœ… Uploads preservados em /tmp/uploads-backup"
          else
            echo "âš ï¸ DiretÃ³rio wp-content/uploads nÃ£o encontrado"
          fi
          
          # APAGAR TUDO do diretÃ³rio atual (SEM EXCEÃ‡ÃƒO)
          echo "ğŸ—‘ï¸ APAGANDO TUDO do diretÃ³rio html..."
          
          # ForÃ§ar remoÃ§Ã£o de pastas que comeÃ§am com 'old' primeiro
          echo "ğŸ§¹ Removendo especificamente pastas 'old*'..."
          for item in * .*; do
            if [[ "$item" == old* ]]; then
              echo "âš ï¸ Encontrada pasta/arquivo 'old*': $item - REMOVENDO..."
              rm -rf "$item" 2>/dev/null || echo "Removido: $item"
            fi
          done
          
          # Listar o que existe antes de apagar
          echo "ğŸ“‹ ConteÃºdo atual do diretÃ³rio:"
          ls -la
          
          # Remover TUDO (arquivos, pastas, ocultos, qualquer coisa)
          echo "ğŸ§¹ Removendo TUDO..."
          
          # Comando especÃ­fico para pastas 'old*'
          echo "ğŸ” Procurando e removendo pastas 'old*'..."
          find . -maxdepth 1 -name "old*" -exec rm -rf {} + 2>/dev/null || echo "Nenhuma pasta old* encontrada"
          
          # Remover tudo o resto
          rm -rf .* * 2>/dev/null || echo "RemoÃ§Ã£o executada"
          
          # Verificar se realmente estÃ¡ vazio
          if [ "$(ls -A)" ]; then
            echo "âš ï¸ Ainda hÃ¡ conteÃºdo, forÃ§ando remoÃ§Ã£o total..."
            # Comando mais agressivo
            find . -mindepth 1 -exec rm -rf {} + 2>/dev/null || echo "RemoÃ§Ã£o forÃ§ada executada"
          fi
          
          # VerificaÃ§Ã£o final
          echo "ğŸ” VerificaÃ§Ã£o final - diretÃ³rio deve estar vazio:"
          ls -la
          
          echo "âœ… DiretÃ³rio html completamente limpo"
          
          echo "ğŸ”„ Copiando arquivos do diretÃ³rio temporÃ¡rio..."
          cp -r /tmp/wordpress-deploy/* ./
          echo "âœ… Arquivos copiados com sucesso"
          
          echo "ğŸ”„ Restaurando uploads preservados..."
          
          # Restaurar APENAS os uploads
          if [ -d "/tmp/uploads-backup" ]; then
            echo "ğŸ“ Restaurando wp-content/uploads..."
            mkdir -p wp-content/uploads
            cp -r /tmp/uploads-backup/* wp-content/uploads/
            echo "âœ… Uploads restaurados com sucesso"
            
            # Limpar backup temporÃ¡rio
            rm -rf /tmp/uploads-backup
            echo "ğŸ—‘ï¸ Backup temporÃ¡rio removido"
          else
            echo "âš ï¸ Nenhum backup de uploads encontrado"
          fi
          
          # Limpar diretÃ³rio temporÃ¡rio de deploy
          rm -rf /tmp/wordpress-deploy
          echo "ğŸ—‘ï¸ DiretÃ³rio temporÃ¡rio de deploy removido"
          
          # Ajustar permissÃµes
          echo "ğŸ” Ajustando permissÃµes dos arquivos..."
          find wp-content -type d -exec chmod 755 {} \;
          find wp-content -type f -exec chmod 644 {} \;
          chmod 755 wp-content
          
          # VerificaÃ§Ã£o final - garantir que nÃ£o hÃ¡ resÃ­duos
          echo "ğŸ” VerificaÃ§Ã£o final - diretÃ³rio deve conter apenas WordPress + uploads:"
          ls -la
          
          # VerificaÃ§Ã£o especÃ­fica para pastas 'old*'
          echo "ğŸ§¹ VerificaÃ§Ã£o final - procurando pastas 'old*'..."
          if [ "$(find . -maxdepth 1 -name 'old*' -type d)" ]; then
            echo "âš ï¸ ATENÃ‡ÃƒO: Pastas 'old*' encontradas apÃ³s deploy!"
            find . -maxdepth 1 -name 'old*' -type d -exec ls -la {} \;
            echo "ğŸ—‘ï¸ Removendo pastas 'old*' encontradas..."
            find . -maxdepth 1 -name 'old*' -type d -exec rm -rf {} +
            echo "âœ… Pastas 'old*' removidas"
          else
            echo "âœ… Nenhuma pasta 'old*' encontrada - deploy limpo!"
          fi
          
          echo "âœ… Deploy concluÃ­do - apenas uploads preservados"