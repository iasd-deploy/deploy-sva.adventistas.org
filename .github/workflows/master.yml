jobs:
  web-deploy:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest
    environment: master
    steps:
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4

      - name: Transform wp-config.php
        run: |
          echo "Init transform: wp-config.php"

          # FunÃ§Ã£o para escapar caracteres especiais em Bash
          escape_sed() {
            echo "$1" | sed -e 's/[\/&]/\\&/g'
          }

          sed -i "s/WP_DB_NAME/$(escape_sed '${{ secrets.WP_DB_NAME }}')/g" ./app/wp-config.php
          sed -i "s/WP_DB_USER/$(escape_sed '${{ secrets.WP_DB_USER }}')/g" ./app/wp-config.php
          sed -i "s/WP_DB_PASSWORD/$(escape_sed '${{ secrets.WP_DB_PASSWORD }}')/g" ./app/wp-config.php
          sed -i "s/WP_DB_HOST/$(escape_sed '${{ secrets.WP_DB_HOST }}')/g" ./app/wp-config.php
          sed -i "s/WP_S3_ACCESS_KEY/$(escape_sed '${{ secrets.WP_S3_ACCESS_KEY }}')/g" ./app/wp-config.php
          sed -i "s/WP_S3_SECRET_KEY/$(escape_sed '${{ secrets.WP_S3_SECRET_KEY }}')/g" ./app/wp-config.php
          sed -i "s/WP_S3_BUCKET/$(escape_sed '${{ secrets.WP_S3_BUCKET }}')/g" ./app/wp-config.php

          echo "End transform: wp-config.php"

      - name: ğŸš€ Smart Deploy to Server
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SOURCE: "./app/"
          REMOTE_HOST: ${{ secrets.FTP_HOST }}
          REMOTE_PORT: 65002
          REMOTE_USER: ${{ secrets.FTP_USER }}
          TARGET: "/home/${{ secrets.FTP_USER }}/domains/sva.adventistas.org/public_html1"
          EXCLUDE: "/dist/, /node_modules/"
          BACKUP: false
          REMOVE_OLD_FILES: true
          STRIP_COMPONENTS: 0
          SCRIPT_BEFORE: |
            cd /home/${{ secrets.FTP_USER }}/domains/sva.adventistas.org/public_html1
            echo "ğŸ§¹ Iniciando a limpeza do diretÃ³rio do site..."

            # 1. Mover o diretÃ³rio de uploads para um local temporÃ¡rio
            if [ -d "wp-content/uploads" ]; then
              echo "ğŸ“ Encontrado 'wp-content/uploads'. Movendo para /tmp/uploads-backup."
              mkdir -p /tmp/uploads-backup
              mv wp-content/uploads /tmp/uploads-backup/
              echo "âœ… 'uploads' movido com sucesso."
            else
              echo "âš ï¸ 'wp-content/uploads' nÃ£o encontrado. Nenhum backup necessÃ¡rio."
            fi

            # 2. Apagar todo o conteÃºdo atual do diretÃ³rio
            echo "ğŸ—‘ï¸ Apagando todo o conteÃºdo do diretÃ³rio atual..."
            # O '.' no final garante que todos os arquivos e diretÃ³rios, incluindo ocultos, sejam removidos.
            rm -rf ./* .* 2>/dev/null || true
            echo "âœ… DiretÃ³rio limpo."
          SCRIPT_AFTER: |
            cd /home/${{ secrets.FTP_USER }}/domains/sva.adventistas.org/public_html1
            echo "ğŸ”„ Restaurando uploads e ajustando permissÃµes..."

            # 3. Restaurar a pasta de uploads para o novo diretÃ³rio wp-content
            if [ -d "/tmp/uploads-backup/uploads" ]; then
              echo "ğŸ“ Restaurando 'wp-content/uploads'..."
              # Garante que a pasta wp-content exista para receber os uploads
              mkdir -p wp-content
              mv /tmp/uploads-backup/uploads wp-content/
              echo "âœ… 'uploads' restaurado com sucesso."
              # Limpar o backup temporÃ¡rio
              rm -rf /tmp/uploads-backup
              echo "ğŸ—‘ï¸ Backup temporÃ¡rio removido."
            else
              echo "âš ï¸ Nenhum backup de uploads encontrado para restaurar."
            fi

            # 4. Ajustar permissÃµes para seguranÃ§a
            echo "ğŸ” Ajustando permissÃµes dos arquivos..."
            # PermissÃµes para diretÃ³rios (755) e arquivos (644)
            find . -type d -exec chmod 755 {} \;
            find . -type f -exec chmod 644 {} \;
            echo "âœ… PermissÃµes ajustadas."

            echo "ğŸš€ Deploy concluÃ­do com sucesso!"