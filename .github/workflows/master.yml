on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest
    environment: master
    steps:
    - name: ðŸšš Get latest code
      uses: actions/checkout@v4

    - name: Transform wp-config.php
      run: |
        echo "Init transform: wp-config.php"

        # FunÃ§Ã£o para escapar caracteres especiais em Bash
        escape_sed() {
          echo "$1" | sed -e 's/[\/&]/\\&/g'
        }

        sed -i "s/WP_DB_NAME/$(escape_sed '${{ secrets.WP_DB_NAME }}')/g" ./app/wp-config.php
        sed -i "s/WP_DB_USER/$(escape_sed '${{ secrets.WP_DB_USER }}')/g" ./app/wp-config.php
        sed -i "s/WP_DB_PASSWORD/$(escape_sed '${{ secrets.WP_DB_PASSWORD }}')/g" ./app/wp-config.php
        sed -i "s/WP_DB_HOST/$(escape_sed '${{ secrets.WP_DB_HOST }}')/g" ./app/wp-config.php
        sed -i "s/WP_S3_ACCESS_KEY/$(escape_sed '${{ secrets.WP_S3_ACCESS_KEY }}')/g" ./app/wp-config.php
        sed -i "s/WP_S3_SECRET_KEY/$(escape_sed '${{ secrets.WP_S3_SECRET_KEY }}')/g" ./app/wp-config.php
        sed -i "s/WP_S3_BUCKET/$(escape_sed '${{ secrets.WP_S3_BUCKET }}')/g" ./app/wp-config.php

        echo "End transform: wp-config.php"

    - name: ðŸ§¹ Smart Clean Server Directory
      run: |
        echo "ðŸ§¹ Preparing smart cleaning strategy..."
        echo "This step will be executed on the server during deploy"

    - name: ðŸš€ Smart Deploy to Server
      uses: easingthemes/ssh-deploy@main
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SOURCE: "./app/"
        REMOTE_HOST: ${{ secrets.FTP_HOST }}
        REMOTE_PORT: 65002
        REMOTE_USER: ${{ secrets.FTP_USER }}
        TARGET: "/home/${{ secrets.FTP_USER }}/domains/sva.adventistas.org/public_html1"
        EXCLUDE: "/dist/, /node_modules/"
        SCRIPT_BEFORE: |
          cd /home/${{ secrets.FTP_USER }}/domains/sva.adventistas.org/public_html1
          echo "ðŸ§¹ Smart cleaning directory before deploy..."
          
          # Preservar wp-content/uploads (arquivos de mÃ­dia)
          if [ -d "wp-content/uploads" ]; then
            echo "ðŸ“ Preserving wp-content/uploads (user media files)"
            mkdir -p /tmp/wp-content-backup/uploads
            cp -r wp-content/uploads/* /tmp/wp-content-backup/uploads/
          fi
          
          # Preservar cache se existir
          if [ -d "wp-content/cache" ]; then
            echo "âš¡ Preserving wp-content/cache"
            mkdir -p /tmp/wp-content-backup/cache
            cp -r wp-content/cache/* /tmp/wp-content-backup/cache/
          fi
          
          # Preservar backups se existir
          if [ -d "wp-content/backup" ]; then
            echo "ðŸ’¾ Preserving wp-content/backup"
            mkdir -p /tmp/wp-content-backup/backup
            cp -r wp-content/backup/* /tmp/wp-content-backup/backup/
          fi
          
          # Limpar diretÃ³rio principal (exceto wp-content)
          echo "ðŸ—‘ï¸ Removing old files (preserving wp-content structure)"
          find . -mindepth 1 -maxdepth 1 ! -name 'wp-content' -exec rm -rf {} +
          
          # Limpar wp-content (exceto uploads, cache, backup)
          if [ -d "wp-content" ]; then
            echo "ðŸ§¹ Cleaning wp-content (preserving user data)"
            cd wp-content
            
            # Remover apenas diretÃ³rios que serÃ£o atualizados
            rm -rf themes plugins languages mu-plugins
            
            # Remover arquivos de cache que serÃ£o recriados
            rm -f advanced-cache.php wp-cache-config.php
            
            # Remover diretÃ³rio de upgrade (temporÃ¡rio)
            rm -rf upgrade
            
            cd ..
          fi
          
          echo "âœ… Smart cleaning completed - user data preserved"
        SCRIPT_AFTER: |
          cd /home/${{ secrets.FTP_USER }}/domains/sva.adventistas.org/public_html1
          echo "ðŸ”„ Restoring preserved user data..."
          
          # Restaurar uploads se existir backup
          if [ -d "/tmp/wp-content-backup/uploads" ]; then
            echo "ðŸ“ Restoring wp-content/uploads"
            cp -r /tmp/wp-content-backup/uploads/* wp-content/uploads/ 2>/dev/null || echo "No uploads to restore"
          fi
          
          # Restaurar cache se existir backup
          if [ -d "/tmp/wp-content-backup/cache" ]; then
            echo "âš¡ Restoring wp-content/cache"
            cp -r /tmp/wp-content-backup/cache/* wp-content/cache/ 2>/dev/null || echo "No cache to restore"
          fi
          
          # Restaurar backups se existir backup
          if [ -d "/tmp/wp-content-backup/backup" ]; then
            echo "ðŸ’¾ Restoring wp-content/backup"
            cp -r /tmp/wp-content-backup/backup/* wp-content/backup/ 2>/dev/null || echo "No backup to restore"
          fi
          
          # Limpar backup temporÃ¡rio
          rm -rf /tmp/wp-content-backup
          
          # Ajustar permissÃµes
          echo "ðŸ” Adjusting file permissions..."
          find wp-content -type d -exec chmod 755 {} \;
          find wp-content -type f -exec chmod 644 {} \;
          chmod 755 wp-content
          
          # Remover qualquer pasta old-* que possa ter sido criada
          echo "ðŸ§¹ Removing any old-* directories..."
          find . -maxdepth 1 -name "old-*" -type d -exec rm -rf {} + 2>/dev/null || echo "No old directories found"
          
          echo "âœ… Deploy completed with user data restored"