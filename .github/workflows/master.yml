on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  web-deploy:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest
    environment: master
    steps:
    - name: ğŸšš Get latest code
      uses: actions/checkout@v4

    - name: Transform wp-config.php
      run: |
        echo "Init transform: wp-config.php"

        # FunÃ§Ã£o para escapar caracteres especiais em Bash
        escape_sed() {
          echo "$1" | sed -e 's/[\/&]/\\&/g'
        }

        sed -i "s/WP_DB_NAME/$(escape_sed '${{ secrets.WP_DB_NAME }}')/g" ./app/wp-config.php
        sed -i "s/WP_DB_USER/$(escape_sed '${{ secrets.WP_DB_USER }}')/g" ./app/wp-config.php
        sed -i "s/WP_DB_PASSWORD/$(escape_sed '${{ secrets.WP_DB_PASSWORD }}')/g" ./app/wp-config.php
        sed -i "s/WP_DB_HOST/$(escape_sed '${{ secrets.WP_DB_HOST }}')/g" ./app/wp-config.php
        sed -i "s/WP_S3_ACCESS_KEY/$(escape_sed '${{ secrets.WP_S3_ACCESS_KEY }}')/g" ./app/wp-config.php
        sed -i "s/WP_S3_SECRET_KEY/$(escape_sed '${{ secrets.WP_S3_SECRET_KEY }}')/g" ./app/wp-config.php
        sed -i "s/WP_S3_BUCKET/$(escape_sed '${{ secrets.WP_S3_BUCKET }}')/g" ./app/wp-config.php

        echo "End transform: wp-config.php"

    - name: ğŸ§¹ Smart Clean Server Directory
      run: |
        echo "ğŸ§¹ Preparing smart cleaning strategy..."
        echo "This step will be executed on the server during deploy"

    - name: ğŸš€ Smart Deploy to Server
      uses: easingthemes/ssh-deploy@main
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SOURCE: "./app/"
        REMOTE_HOST: ${{ secrets.FTP_HOST }}
        REMOTE_PORT: 65002
        REMOTE_USER: ${{ secrets.FTP_USER }}
        TARGET: "/home/${{ secrets.FTP_USER }}/domains/sva.adventistas.org/public_html1"
        EXCLUDE: "/dist/, /node_modules/"
        BACKUP: false
        REMOVE_OLD_FILES: true
        SCRIPT_BEFORE: |
          cd /home/${{ secrets.FTP_USER }}/domains/sva.adventistas.org/public_html1
          echo "ğŸ§¹ Limpando TUDO do diretÃ³rio html..."
          
          # Preservar APENAS os uploads (arquivos de mÃ­dia dos usuÃ¡rios)
          if [ -d "wp-content/uploads" ]; then
            echo "ğŸ“ Preservando wp-content/uploads (arquivos de mÃ­dia)"
            mkdir -p /tmp/uploads-backup
            cp -r wp-content/uploads/* /tmp/uploads-backup/
            echo "âœ… Uploads preservados em /tmp/uploads-backup"
          else
            echo "âš ï¸ DiretÃ³rio wp-content/uploads nÃ£o encontrado"
          fi
          
          # APAGAR TUDO do diretÃ³rio atual (SEM EXCEÃ‡ÃƒO)
          echo "ğŸ—‘ï¸ APAGANDO TUDO do diretÃ³rio html..."
          
          # Listar o que existe antes de apagar
          echo "ğŸ“‹ ConteÃºdo atual do diretÃ³rio:"
          ls -la
          
          # Remover TUDO (arquivos, pastas, ocultos, qualquer coisa)
          echo "ğŸ§¹ Removendo TUDO..."
          rm -rf .* * 2>/dev/null || echo "RemoÃ§Ã£o executada"
          
          # Verificar se realmente estÃ¡ vazio
          if [ "$(ls -A)" ]; then
            echo "âš ï¸ Ainda hÃ¡ conteÃºdo, forÃ§ando remoÃ§Ã£o total..."
            # Comando mais agressivo
            find . -mindepth 1 -exec rm -rf {} + 2>/dev/null || echo "RemoÃ§Ã£o forÃ§ada executada"
          fi
          
          # VerificaÃ§Ã£o final
          echo "ğŸ” VerificaÃ§Ã£o final - diretÃ³rio deve estar vazio:"
          ls -la
          
          echo "âœ… DiretÃ³rio html completamente limpo"
          
          # Recriar estrutura bÃ¡sica
          echo "ğŸ“ Recriando estrutura bÃ¡sica..."
          mkdir -p wp-content
          echo "âœ… Estrutura bÃ¡sica recriada"
        SCRIPT_AFTER: |
          cd /home/${{ secrets.FTP_USER }}/domains/sva.adventistas.org/public_html1
          echo "ğŸ”„ Restaurando uploads preservados..."
          
          # Restaurar APENAS os uploads
          if [ -d "/tmp/uploads-backup" ]; then
            echo "ğŸ“ Restaurando wp-content/uploads..."
            mkdir -p wp-content/uploads
            cp -r /tmp/uploads-backup/* wp-content/uploads/
            echo "âœ… Uploads restaurados com sucesso"
            
            # Limpar backup temporÃ¡rio
            rm -rf /tmp/uploads-backup
            echo "ğŸ—‘ï¸ Backup temporÃ¡rio removido"
          else
            echo "âš ï¸ Nenhum backup de uploads encontrado"
          fi
          
          # Ajustar permissÃµes
          echo "ğŸ” Ajustando permissÃµes dos arquivos..."
          find wp-content -type d -exec chmod 755 {} \;
          find wp-content -type f -exec chmod 644 {} \;
          chmod 755 wp-content
          
          # VerificaÃ§Ã£o final - garantir que nÃ£o hÃ¡ resÃ­duos
          echo "ğŸ” VerificaÃ§Ã£o final - diretÃ³rio deve conter apenas WordPress + uploads:"
          ls -la
          
          echo "âœ… Deploy concluÃ­do - apenas uploads preservados"